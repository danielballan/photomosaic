dist: xenial
language: python
sudo: false
matrix:
  fast_finish: true
  include:
    - python: 3.5
    - python: 3.6
    - python: 3.7
      env: PUBLISH_DOCS=1

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/.cache/matplotlib
    - $HOME/pools/

env:
  global:
    # Doctr deploy key for danielballan.github.io/photomosaic
    - secure: "f6PzI9At5FKvozluhLQnOvNB2wwVdvoVA7hur4PN5E5PbHWeICeNbj15VkIxChUUUwTXEI/mSMMRvYpDHFr205RxaNuv+/lyLo4H1VqiVlZvZi6jJLB2paYwu0AqsAeTjO5XrgKgByuwWDlQIwP02hnxgGD3LbD83h/Trh0Yln4="

install:
  # Install this package and the packages listed in requirements.txt.
  - pip install .[parallel]
  # Install extra requirements for running tests and building docs.
  - pip install -r requirements-dev.txt

script:
  - coverage run -m pytest  # Run the tests and check for test coverage.
  - coverage report -m  # Generate test coverage report.
  - codecov  # Upload the report to codecov.
  - flake8  # Enforce code style.
  - set -e
  - make -C doc pools  # Generate tile pools used in documentation.
  - make -C doc images  # Generate example images used in documentation.
  - make -C doc html  # Build the documentation.
  - |
    if [ $PUBLISH_DOCS ]; then
      # Pubish the documentation to GitHub Pages.
      pip install doctr;
      doctr deploy docs --built-docs doc/build/html;
    fi
